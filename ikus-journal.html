<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/svg" href="iku.svg">
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>iku's journal</title>
  
  <script type="module">
    // 1. IMPORT FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 2. CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyBdkI7GUPRJsxLtBlp9gaQNlR7nz-JDi2g",
      databaseURL: "https://iku-website-iku-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iku-website-iku",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ADMIN_PASSWORD_HASH = 'aWt1Y29tZWw='; // 'ikucomel'
    let isAdmin = sessionStorage.getItem('ikus_admin') === '1';

    // 3. CLOUD SYNC: This runs automatically when data changes in the cloud
    onValue(ref(db, 'entries'), (snapshot) => {
      const data = snapshot.val();
      render(data);
    });

    // 4. THE RENDER FUNCTION
    function render(data) {
      const list = document.getElementById('entries');
      list.innerHTML = '';
      
      if (!data) {
        list.innerHTML = '<p class="muted">No entries yet.</p>';
        return;
      }

      // Convert the cloud object into a list we can sort
      const entries = Object.keys(data).map(key => ({ id: key, ...data[key] }));
      
      // Show newest first
      entries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((e) => {
        const card = document.createElement('div');
        card.className = 'journal-entry';
        card.innerHTML = `
          <div class="entry-date">${new Date(e.date).toLocaleString()}</div>
          <div class="entry-content"></div>
        `;
        // Use textContent for safety against hackers
        card.querySelector('.entry-content').textContent = e.text;

        if (isAdmin) {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.className = 'entry-delete';
          delBtn.onclick = () => { 
            if(confirm('Delete this entry from the cloud?')) {
              remove(ref(db, `entries/${e.id}`));
            }
          };
          card.appendChild(delBtn);
        }
        list.appendChild(card);
      });
    }

    // 5. BUTTON CLICKS & LOGIN
    document.addEventListener('DOMContentLoaded', () => {
      const saveBtn = document.getElementById('saveBtn');
      const noteInput = document.getElementById('note');
      const passInput = document.getElementById('adminPassInline');
      const showLoginBtn = document.getElementById('showLoginInline');
      const loginBox = document.getElementById('loginBoxInline');
      const logoutBtn = document.getElementById('logoutInlineVisible');
      const editorArea = document.getElementById('editorArea');

      // Admin check
      if (isAdmin) {
        editorArea.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        showLoginBtn.style.display = 'none';
      }

      // Save to Cloud
      saveBtn.onclick = () => {
        const text = noteInput.value.trim();
        if (text) {
          push(ref(db, 'entries'), {
            date: new Date().toISOString(),
            text: text
          });
          noteInput.value = '';
        }
      };

      // Clear All (Cloud)
      document.getElementById('clearAll').onclick = () => {
        if(confirm('Delete EVERY entry from the cloud?')) {
          remove(ref(db, 'entries'));
        }
      };

      // Login Logic
      showLoginBtn.onclick = () => {
        loginBox.style.display = loginBox.style.display === 'none' ? 'block' : 'none';
      };

      passInput.onkeydown = (e) => {
        if (e.key === 'Enter') {
          if (btoa(passInput.value) === ADMIN_PASSWORD_HASH) {
            sessionStorage.setItem('ikus_admin', '1');
            location.reload();
          } else {
            alert('Wrong code');
          }
        }
      };

      logoutBtn.onclick = () => {
        sessionStorage.removeItem('ikus_admin');
        location.reload();
      };
    });
  </script>
</head>
<body>

  <h1>iku's journal</h1>

  <div class="journal-container">
    <div id="editorArea" style="display:none;">
      <label for="note">New entry</label>
      <textarea id="note" rows="6" placeholder="Write today's entry..."></textarea>
      <div>
        <button type="button" id="saveBtn">Save Entry</button>
        <button type="button" id="clearAll">Clear All</button>
      </div>
    </div>

    <h2>Entries</h2>
    <div id="entries" aria-live="polite"></div>

    <div id="bottomControls">
      <a class="icon-btn" href="index.html" aria-label="Back to Home">
        <span class="icon-symbol">ğŸ </span>
        <span class="icon-text">HOME</span>
      </a>
      <div id="inlineAdmin">
        <button type="button" id="showLoginInline" class="lock-btn" aria-label="Secret code">ğŸ”’</button>
        <button type="button" id="logoutInlineVisible" class="icon-btn" style="display:none; margin-left:6px;" aria-label="Sign out">Sign out</button>
        <div id="loginBoxInline" style="display:none;">
          <input id="adminPassInline" type="password" placeholder="Secret code">
        </div>
      </div>
    </div>
  </div>

</body>
</html>
